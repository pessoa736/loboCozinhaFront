<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Page Title</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap');
        .testMenu {
            position: fixed;
            background-color: #00000044;
            backdrop-filter: blur(15px) saturate(180%);
            box-shadow: 0 4px 8px 0 #00000088, 0 6px 20px 0 #00000088;
            margin: 1%;
            min-width: 150px;
            min-height: 50px;
            border-radius: 15px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1%;
            box-sizing: border-box;
            z-index: 1000;
            border: 1px solid #ffffff22;
            
            .Select, .Button{
                border-radius: 15px;
                width: 100%;
                height: 20px;
                border: none;
                background-color: #00000000;
                color: white;
                border: 2px solid #ffffff66;
                height: 32px;
                text-align: center;
                font-family: 'Quicksand', sans-serif;
                font-weight: 900;
            }

            & select:hover, button:hover, option:hover {
                    background-color: #ffffff22;
            }
            & select:focus, button:focus {
                    outline: none;
                    border: 1px solid #ffffff88;
                    background-color: #ffffff11;
            }
            .hiderButton{
                width: 100%;
                border: none;
            }
            & option {
                background-color: #00000011;
                color: black;
            }

            & div {
                margin-bottom: 10px;
                width: 100%;
                gap: 3px;
                display: flex;
                flex-direction: column;
            }

            /* header + collapse styles */
            .menu-header {
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 8px;
                margin-bottom: 8px;
                user-select: none;
            }
            .menu-header h3 {
                margin: 0;
                font-family: 'Quicksand', sans-serif;
                font-weight: 800;
                font-size: 14px;
                opacity: 0.9;
            }
            .toggle-btn {
                width: 32px;
                height: 32px;
                min-width: 32px;
                padding: 0;
                line-height: 28px;
                text-align: center;
                border-radius: 10px;
            }
            .menu-content { width: 100%; }
        }
        /* flattened nested selectors */
        .testMenu.collapsed {
            padding: 8px 10px;
            min-height: auto;
        }
        .testMenu.collapsed .menu-content { display: none; }
        

        .componentArea {
            margin: 1%;
            padding: 1%;
            justify-content: center;
            align-content: center;
            display: flex;
            height: 100vh;
            box-sizing: border-box;
        }

        .bodyTest {
            margin: 0;
            padding: 0;
            background-color: #000;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        .load {
            color: white;
            font-size: 30px;
            text-align: center;
            text-justify: center;
            margin-top: 20%;
        }
    </style>
</head>
<body class="bodyTest">
    
    
    
    <div class="componentArea"></div>

    <div class="testMenu">
        <div class="menu-header">
            <h3 style="margin:0">Menu de Testes</h3>
            <button id="collapseBtn" class="hiderButton Button" type="button" aria-label="Recolher menu" aria-expanded="true" title="Recolher menu">▾</button>
        </div>
        <div class="menu-content">
            <div>
                <h3>Testar Componente:</h3>
                <select id="componentSelect" class="Select">
                </select>
                <button id="loadBtn" type="button" class="Button">Load</button>
            </div>
            <div>
                <h3 style="margin-right: 10px;">reposicionar menu</h3>
                <select id="positionSelectX" class="Select">
                    <option value="direita">direita</option>
                    <option value="esquerda">esquerda</option>
                </select>

                <select id="positionSelectY" class="Select">
                    <option value="cima">cima</option>
                    <option value="baixo">baixo</option>
                </select>

                <button type="button" id="movebtn" class="Button">Mover</button>

                <h3>Selecionar Tema</h3>
                <select id="themeSelect" class="Select">
                    <option value="dark">dark</option>
                    <option value="light">light</option>
                </select>

                <button type="button" id="themebtn" class="Button">Mudar Tema</button>
            </div>
        </div>
    </div>



    <script type="module">
        import Component, { watchComponent } from './render.test.js';

        function executeScriptsIn(container) {
            const scripts = Array.from(container.querySelectorAll('script'));
            for (const oldScript of scripts) {
                const newScript = document.createElement('script');
                if (oldScript.type) newScript.type = oldScript.type;
                if (oldScript.src) {
                    newScript.src = oldScript.src;
                    newScript.async = false;
                } else {
                    newScript.textContent = oldScript.textContent;
                }
                // Preserve attributes like 'defer' if needed
                for (const attr of oldScript.attributes) {
                    if (attr.name !== 'src' && attr.name !== 'type') newScript.setAttribute(attr.name, attr.value);
                }
                oldScript.parentNode.replaceChild(newScript, oldScript);
            }
        }

        await fetch('./render.test.json')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('componentSelect');
                data.forEach(component => {
                    const option = document.createElement('option');
                    option.value = component;
                    option.textContent = component;
                    select.appendChild(option);
                });
                loadComponent();
            })
            .catch(error => console.error('Error loading component list:', error));

        let watcher = null;
        async function loadComponent() {
            console.log('Loading component...');
            document.querySelector('.componentArea').innerHTML = '<p class="load">Loading...</p>';
            const selected = document.getElementById('componentSelect').value;
            // stop previous watcher if any
            if (watcher) { try { watcher.stop(); } catch (_) {} watcher = null; }
            watcher = await watchComponent(selected, {
                intervalMs: 1000,
                onRender: (html) => {
                    console.log('html do ' + selected + ':', html);
                    const area = document.querySelector('.componentArea');
                    area.innerHTML = html;
                    executeScriptsIn(area);
                }
            });
        }

        function mudarMenuDeLado() {
            const posX = document.getElementById('positionSelectX').value;
            const posY = document.getElementById('positionSelectY').value;
            const menu = document.querySelector('.testMenu');
            if (posX === 'esquerda') menu.style.left = '0'; else menu.style.left = '';
            if (posX === 'direita') menu.style.right = '0'; else menu.style.right = '';
            if (posY === 'cima') menu.style.top = '0'; else menu.style.top = '';
            if (posY === 'baixo') menu.style.bottom = '0'; else menu.style.bottom = '';
        }

        function mudarTema() {
            const tema = document.getElementById('themeSelect').value;
            if (tema === 'dark') {
                document.body.style.backgroundColor = '#000';
                document.body.style.color = 'white';
            } else {
                document.body.style.backgroundColor = '#fff';
                document.body.style.color = 'black';
            }
        }

        // collapse/expand menu
        const testMenu = document.querySelector('.testMenu');
        const collapseBtn = document.getElementById('collapseBtn');
        function updateCollapseBtn() {
            const collapsed = testMenu.classList.contains('collapsed');
            collapseBtn.setAttribute('aria-expanded', String(!collapsed));
            collapseBtn.title = collapsed ? 'Expandir menu' : 'Recolher menu';
            collapseBtn.textContent = collapsed ? '▸' : '▾';
        }
        function toggleMenuCollapse() {
            testMenu.classList.toggle('collapsed');
            const isCollapsed = testMenu.classList.contains('collapsed');
            try { localStorage.setItem('testMenuCollapsed', String(isCollapsed)); } catch(_) {}
            updateCollapseBtn();
        }
        // init collapsed state from storage
        try {
            const pref = localStorage.getItem('testMenuCollapsed');
            if (pref === 'true') testMenu.classList.add('collapsed');
        } catch(_) {}
        updateCollapseBtn();

        document.getElementById('themebtn').addEventListener('click', mudarTema);
        mudarTema();
    document.getElementById('loadBtn').addEventListener('click', loadComponent);
    document.getElementById('componentSelect').addEventListener('change', loadComponent);
        loadComponent();
        document.getElementById('movebtn').addEventListener('click', mudarMenuDeLado);
        mudarMenuDeLado();
        collapseBtn.addEventListener('click', toggleMenuCollapse);
        document.querySelector('.menu-header').addEventListener('dblclick', toggleMenuCollapse);
    </script>
    </div>
</body>
</html>